### **聚类分析算法设计方案**

#### **1. 问题定义**

- **目标**：基于食谱的营养成分（卡路里、脂肪、蛋白质等）和用户反馈（评分、评论数），将相似食谱聚为一类，挖掘不同类别食谱的特征差异。
- **数据输入**：
  - `recipes.parquet`：包含食谱 ID、名称、营养成分、评分等信息。
  - `reviews.parquet`：包含用户评论数据（代码中未深度使用，主要基于食谱自身评分）。
- **输出**：
  - 聚类结果（每个食谱所属类别）。
  - 类别特征分析（如平均营养值、评分分布等）。

#### **2. 算法选型**

- **主算法**：K-means 聚类（基于 Spark MLlib 实现，适合大规模数据）。
- **辅助算法/技术**：
  - **特征工程**：标准化（消除量纲影响）、衍生特征（如健康评分、每份量卡路里）。
  - **最优 K 值确定**：轮廓系数（Silhouette Score），通过肘部法则可视化辅助判断。
  - **降维与可视化**：PCA（主成分分析），用于二维平面展示高维聚类结果。

#### **3. 流程设计**

##### **3.1 数据加载与预处理**

- **数据清洗**：
  - 过滤缺失值：保留评分（`AggregatedRating`）、评论数（`ReviewCount`）非空的食谱，并要求评论数 ≥ 5（保证评分可信度）。
  - 填充营养成分缺失值：使用中位数填充（`approxQuantile`近似计算，适合大数据场景）。
- **特征工程**：
  - **基础特征**：卡路里、脂肪、蛋白质、碳水化合物、钠、糖、纤维、评分、评论数。
  - **衍生特征**：
    - **每份量卡路里（CaloriesPerServing）**：`Calories / RecipeServings`（避免因份量差异导致的卡路里偏差）。
    - **总脂肪（TotalFat）**：`FatContent + SaturatedFatContent`（反映脂肪总负荷）。
    - **健康评分（HealthScore）**：`(纤维 + 蛋白质) / (糖 + 饱和脂肪 + 1)`（正向指标衡量健康程度）。

##### **3.2 特征标准化与向量化**

- **向量化**：使用`VectorAssembler`将选定特征合并为`features`向量。
- **标准化**：通过`StandardScaler`对特征向量进行标准化，使各特征均值为 0、方差为 1，避免数值范围较大的特征（如卡路里）主导聚类结果。

##### **3.3 聚类模型构建与调优**

- **K 值搜索范围**：`k_range=(2, 10)`（经验性范围，可根据数据规模调整）。
- **轮廓系数计算**：
  - 对每个 K 值，使用`ClusteringEvaluator`计算轮廓系数（值越接近 1，聚类效果越好）。
  - 选择轮廓系数最高的 K 值作为最优聚类数。
- **模型训练**：使用最优 K 值重新训练 K-means 模型，生成最终聚类标签（`cluster`）。

##### **3.4 结果分析与可视化**

- **统计分析**：
  - 计算各聚类的食谱数量、平均营养值、评分等统计量，识别类别特征（如高卡路里类、高评分类）。
- **可视化**：
  - **PCA 降维图**：将高维特征投影到二维平面，直观展示聚类分布。
  - **营养成分对比图**：通过柱状图对比各聚类的营养均值差异。
  - **评分/健康评分分布图**：分析不同类别在用户反馈和健康属性上的差异。

##### **3.5 结果保存**

- 保存聚类结果到 Parquet 文件，包含食谱 ID、名称、类别及关键特征。
- 保存聚类统计摘要到 CSV 文件，便于后续分析。
